<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Faraday - CORS Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .credentials { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .log { font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 5px 0; max-height: 200px; overflow-y: auto; }
        h1 { color: #495057; }
        h2 { color: #6c757d; border-bottom: 2px solid #dee2e6; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test API Faraday - R√©solution CORS</h1>
        
        <div class="credentials">
            <strong>üìã Credentials de test:</strong><br>
            ‚Ä¢ Username: <code>faraday</code><br>
            ‚Ä¢ Password: <code>faraday</code><br>
            ‚Ä¢ Server: <code>http://localhost:5985</code>
        </div>

        <div class="test-section">
            <h2>üåê 1. Test Connectivit√© Serveur</h2>
            <button class="btn-primary" onclick="testServerConnection()">Tester Connexion Serveur</button>
            <div id="server-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>üîë 2. Test Authentification API</h2>
            <button class="btn-primary" onclick="testAPIAuth()">Tester Auth API</button>
            <button class="btn-warning" onclick="testMockAuth()">Mode Simul√©</button>
            <div id="auth-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>üìä 3. Test Endpoints Faraday</h2>
            <button class="btn-success" onclick="testInfo()">Test /info</button>
            <button class="btn-success" onclick="testWorkspaces()">Test /ws</button>
            <button class="btn-success" onclick="testHosts()">Test /hosts</button>
            <div id="endpoints-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>üîß 4. Solutions CORS</h2>
            <button class="btn-warning" onclick="showCORSSolutions()">Afficher Solutions</button>
            <div id="cors-solutions" class="result" style="display: none;">
                <h3>Solutions pour r√©soudre les erreurs CORS :</h3>
                <ol>
                    <li><strong>Serveur HTTP Local :</strong> <code>python -m http.server 8080</code></li>
                    <li><strong>Chrome avec CORS d√©sactiv√© :</strong> <code>--disable-web-security --user-data-dir="C:/temp/chrome"</code></li>
                    <li><strong>Firefox avec CORS d√©sactiv√© :</strong> about:config ‚Üí <code>security.fileuri.strict_origin_policy = false</code></li>
                    <li><strong>Extension CORS :</strong> Installer "CORS Unblock" ou similaire</li>
                    <li><strong>Mode d√©veloppement :</strong> Utiliser les donn√©es simul√©es</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h2>üìù 5. Logs de Debug</h2>
            <button class="btn-primary" onclick="clearLogs()">Effacer Logs</button>
            <div id="debug-logs" class="log">Aucun log pour le moment...</div>
        </div>
    </div>

    <script>
        // Configuration API
        const API_CONFIG = {
            baseURL: 'http://localhost:5985',
            apiVersion: '_api/v3',
            username: 'faraday',
            password: 'faraday',
            credentials: btoa('faraday:faraday')
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debug-logs');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = 'Logs effac√©s...<br>';
        }

        async function testServerConnection() {
            const resultDiv = document.getElementById('server-result');
            resultDiv.innerHTML = '‚è≥ Test de connexion en cours...';
            log('D√©but test connexion serveur', 'info');

            try {
                const response = await fetch(`${API_CONFIG.baseURL}`, {
                    method: 'GET',
                    mode: 'no-cors'  // Mode no-cors pour √©viter les erreurs CORS
                });
                
                resultDiv.innerHTML = '<span class="success">‚úÖ Serveur accessible</span><br>Mode: no-cors (r√©ponse opaque)';
                log('Serveur accessible via no-cors', 'success');
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Serveur inaccessible</span><br>Erreur: ${error.message}`;
                log(`Erreur serveur: ${error.message}`, 'error');
            }
        }

        async function testAPIAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '‚è≥ Test authentification en cours...';
            log('D√©but test authentification API', 'info');

            const testStrategies = [
                {
                    name: 'CORS Standard',
                    config: {
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Authorization': `Basic ${API_CONFIG.credentials}`,
                            'Content-Type': 'application/json'
                        }
                    }
                },
                {
                    name: 'CORS avec credentials',
                    config: {
                        mode: 'cors',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Basic ${API_CONFIG.credentials}`,
                            'Content-Type': 'application/json'
                        }
                    }
                },
                {
                    name: 'No-CORS',
                    config: {
                        mode: 'no-cors',
                        headers: {
                            'Authorization': `Basic ${API_CONFIG.credentials}`
                        }
                    }
                }
            ];

            let success = false;
            let results = [];

            for (let strategy of testStrategies) {
                try {
                    log(`Test strat√©gie: ${strategy.name}`, 'info');
                    const response = await fetch(`${API_CONFIG.baseURL}/${API_CONFIG.apiVersion}/info`, {
                        method: 'GET',
                        ...strategy.config
                    });

                    if (strategy.name === 'No-CORS') {
                        results.push(`${strategy.name}: ‚úÖ Requ√™te envoy√©e (r√©ponse opaque)`);
                        log(`${strategy.name}: Requ√™te no-cors envoy√©e`, 'success');
                    } else if (response.ok) {
                        const data = await response.json();
                        results.push(`${strategy.name}: ‚úÖ Succ√®s - Version ${data.Version || data['Faraday Server']}`);
                        success = true;
                        log(`${strategy.name}: Succ√®s - ${JSON.stringify(data)}`, 'success');
                        break;
                    } else {
                        results.push(`${strategy.name}: ‚ùå HTTP ${response.status}`);
                        log(`${strategy.name}: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    results.push(`${strategy.name}: ‚ùå ${error.message}`);
                    log(`${strategy.name}: ${error.message}`, 'error');
                }
            }

            if (success) {
                resultDiv.innerHTML = `<span class="success">‚úÖ Authentification r√©ussie!</span><br>${results.join('<br>')}`;
            } else {
                resultDiv.innerHTML = `<span class="error">‚ùå √âchec authentification</span><br>${results.join('<br>')}<br><br><span class="warning">üí° Essayez le mode simul√© ou configurez CORS</span>`;
            }
        }

        async function testMockAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '‚è≥ Test mode simul√©...';
            log('Test mode simul√©', 'info');

            // Simuler une authentification r√©ussie
            setTimeout(() => {
                resultDiv.innerHTML = `
                    <span class="success">‚úÖ Mode simul√© activ√©!</span><br>
                    <strong>Utilisateur:</strong> ${API_CONFIG.username}<br>
                    <strong>Version:</strong> 5.14.1 (Simul√©)<br>
                    <span class="info">‚ÑπÔ∏è Les donn√©es seront simul√©es pour le d√©veloppement</span>
                `;
                log('Mode simul√© activ√© avec succ√®s', 'success');
            }, 1000);
        }

        async function testInfo() {
            await testEndpoint('info', 'Info Serveur');
        }

        async function testWorkspaces() {
            await testEndpoint('ws', 'Workspaces');
        }

        async function testHosts() {
            await testEndpoint('ws/demo-workspace/hosts', 'Hosts', true);
        }

        async function testEndpoint(endpoint, name, mockFallback = false) {
            const resultDiv = document.getElementById('endpoints-result');
            const url = `${API_CONFIG.baseURL}/${API_CONFIG.apiVersion}/${endpoint}`;
            
            log(`Test endpoint: ${name} (${endpoint})`, 'info');
            resultDiv.innerHTML += `<div>‚è≥ Test ${name}...</div>`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Authorization': `Basic ${API_CONFIG.credentials}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML += `<div class="success">‚úÖ ${name}: ${JSON.stringify(data).substring(0, 100)}...</div>`;
                    log(`${name}: Succ√®s - ${JSON.stringify(data).substring(0, 200)}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`${name}: Erreur - ${error.message}`, 'error');
                
                if (mockFallback) {
                    // Utiliser des donn√©es simul√©es
                    const mockData = getMockData(endpoint);
                    resultDiv.innerHTML += `<div class="warning">‚ö†Ô∏è ${name}: Mode simul√© - ${JSON.stringify(mockData).substring(0, 100)}...</div>`;
                    log(`${name}: Fallback vers donn√©es simul√©es`, 'warning');
                } else {
                    resultDiv.innerHTML += `<div class="error">‚ùå ${name}: ${error.message}</div>`;
                }
            }
        }

        function getMockData(endpoint) {
            const mockData = {
                'info': { 'Faraday Server': 'Running', 'Version': '5.14.1' },
                'ws': [
                    { name: 'demo-workspace', description: 'Demo workspace' },
                    { name: 'test-workspace', description: 'Test workspace' }
                ],
                'ws/demo-workspace/hosts': [
                    { ip: '192.168.1.1', hostnames: ['router'], os: 'Linux' },
                    { ip: '192.168.1.100', hostnames: ['pc'], os: 'Windows' }
                ]
            };
            return mockData[endpoint] || { message: 'Mock data' };
        }

        function showCORSSolutions() {
            const solutionsDiv = document.getElementById('cors-solutions');
            solutionsDiv.style.display = solutionsDiv.style.display === 'none' ? 'block' : 'none';
            log('Affichage des solutions CORS', 'info');
        }

        // Auto-test au chargement
        window.addEventListener('load', () => {
            log('Page de test API charg√©e', 'info');
            setTimeout(() => {
                testServerConnection();
            }, 1000);
        });
    </script>
</body>
</html>
